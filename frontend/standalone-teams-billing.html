<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standalone Teams & Billing - ninaivalaigal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Standalone Teams</h1>
                    <div class="ml-4">
                        <span id="currentPlan" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            Free Plan
                        </span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="createTeamBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>Create Team
                    </button>
                    <button id="upgradeBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-arrow-up mr-2"></i>Upgrade Plan
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Team Overview Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-blue-100 rounded-lg">
                        <i class="fas fa-users text-blue-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Team Members</p>
                        <p class="text-2xl font-bold text-gray-900" id="teamMembersCount">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-green-100 rounded-lg">
                        <i class="fas fa-brain text-green-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Memories</p>
                        <p class="text-2xl font-bold text-gray-900" id="memoriesCount">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-layer-group text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Contexts</p>
                        <p class="text-2xl font-bold text-gray-900" id="contextsCount">-</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-purple-100 rounded-lg">
                        <i class="fas fa-dollar-sign text-purple-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Credits</p>
                        <p class="text-2xl font-bold text-gray-900">$<span id="creditsBalance">-</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Meters -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Usage This Month</h3>
            </div>
            <div class="p-6">
                <div id="usageMeters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Usage meters will be populated here -->
                </div>
            </div>
        </div>

        <!-- Team Management & Billing -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Team Members -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-lg font-medium text-gray-900">Team Members</h3>
                    <button id="inviteMemberBtn" class="text-sm text-blue-600 hover:text-blue-800">
                        <i class="fas fa-user-plus mr-1"></i>Invite Member
                    </button>
                </div>
                <div class="p-6">
                    <div id="teamMembersList" class="space-y-4">
                        <!-- Team members will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Billing Information -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Billing Information</h3>
                </div>
                <div class="p-6">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Current Plan</span>
                            <span class="text-sm font-medium text-gray-900" id="billingPlanName">Free Plan</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Monthly Cost</span>
                            <span class="text-sm font-medium text-gray-900">$<span id="monthlyCost">0.00</span></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Next Billing</span>
                            <span class="text-sm font-medium text-gray-900" id="nextBilling">N/A</span>
                        </div>
                        <div class="pt-4 border-t">
                            <button id="manageBillingBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                Manage Billing
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Team Modal -->
    <div id="createTeamModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Create Standalone Team</h3>
                </div>
                <form id="createTeamForm" class="px-6 py-4">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Team Name</label>
                        <input type="text" id="teamName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                        <textarea id="teamDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Members</label>
                        <select id="maxMembers" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="5">5 members</option>
                            <option value="10" selected>10 members</option>
                            <option value="25">25 members</option>
                        </select>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Initial Plan</label>
                        <select id="billingPlan" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="free">Free Plan ($0/month)</option>
                            <option value="starter">Starter Plan ($10/month)</option>
                        </select>
                    </div>
                </form>
                
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button id="cancelCreateTeam" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                    <button id="confirmCreateTeam" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Create Team</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTeamId = 'team-001';
        let teamData = null;
        let billingData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadTeamData();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('createTeamBtn').addEventListener('click', () => {
                document.getElementById('createTeamModal').classList.remove('hidden');
            });

            document.getElementById('cancelCreateTeam').addEventListener('click', () => {
                document.getElementById('createTeamModal').classList.add('hidden');
            });

            document.getElementById('confirmCreateTeam').addEventListener('click', createTeam);

            document.getElementById('manageBillingBtn').addEventListener('click', () => {
                window.open('/team-billing-portal', '_blank');
            });
        }

        async function loadTeamData() {
            try {
                const response = await fetch(`/standalone-teams/${currentTeamId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    teamData = await response.json();
                    await loadBillingData();
                    renderTeamDashboard();
                }
            } catch (error) {
                console.error('Error loading team data:', error);
            }
        }

        async function loadBillingData() {
            try {
                const response = await fetch(`/standalone-teams/${currentTeamId}/billing`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    billingData = await response.json();
                }
            } catch (error) {
                console.error('Error loading billing data:', error);
            }
        }

        function renderTeamDashboard() {
            if (!teamData || !billingData) return;

            // Update overview cards
            document.getElementById('teamMembersCount').textContent = teamData.current_members;
            document.getElementById('memoriesCount').textContent = billingData.usage_stats.current_period.memories_this_month || 0;
            document.getElementById('contextsCount').textContent = billingData.usage_stats.current_period.contexts || 0;
            
            const totalCredits = billingData.credits.reduce((sum, credit) => sum + credit.remaining_amount, 0);
            document.getElementById('creditsBalance').textContent = totalCredits.toFixed(2);

            // Update plan information
            document.getElementById('currentPlan').textContent = billingData.current_plan.name;
            document.getElementById('billingPlanName').textContent = billingData.current_plan.name;
            document.getElementById('monthlyCost').textContent = billingData.current_plan.price.toFixed(2);

            // Render usage meters
            renderUsageMeters();
        }

        function renderUsageMeters() {
            const container = document.getElementById('usageMeters');
            container.innerHTML = '';

            const usage = billingData.usage_stats.current_period;
            const limits = billingData.usage_stats.limits;

            const meters = [
                { name: 'Members', current: usage.members || 0, limit: limits.max_members, unit: 'members' },
                { name: 'Memories', current: usage.memories_this_month || 0, limit: limits.memories_per_month, unit: 'memories' },
                { name: 'Contexts', current: usage.contexts || 0, limit: limits.contexts, unit: 'contexts' }
            ];

            meters.forEach(meter => {
                const percentage = Math.round((meter.current / meter.limit) * 100);
                const progressColor = percentage >= 90 ? 'bg-red-500' : 
                                    percentage >= 75 ? 'bg-yellow-500' : 'bg-green-500';

                const meterDiv = document.createElement('div');
                meterDiv.className = 'bg-gray-50 rounded-lg p-4';
                
                meterDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-medium text-gray-900">${meter.name}</h4>
                        <span class="text-sm text-gray-500">${percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="${progressColor} h-2 rounded-full" style="width: ${Math.min(percentage, 100)}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>${meter.current.toLocaleString()} ${meter.unit}</span>
                        <span>${meter.limit.toLocaleString()} ${meter.unit}</span>
                    </div>
                `;
                container.appendChild(meterDiv);
            });
        }

        async function createTeam() {
            const formData = {
                name: document.getElementById('teamName').value,
                description: document.getElementById('teamDescription').value,
                max_members: parseInt(document.getElementById('maxMembers').value),
                billing_plan: document.getElementById('billingPlan').value
            };

            try {
                const response = await fetch('/standalone-teams/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const result = await response.json();
                    currentTeamId = result.id;
                    document.getElementById('createTeamModal').classList.add('hidden');
                    loadTeamData();
                    alert('Team created successfully!');
                } else {
                    const error = await response.json();
                    alert(`Error creating team: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error creating team:', error);
                alert('Error creating team');
            }
        }
    </script>
</body>
</html>
