<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Billing Portal - ninaivalaigal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-semibold text-gray-900">Team Billing Portal</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="upgradeBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-arrow-up mr-2"></i>Upgrade Plan
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Billing Alerts -->
        <div id="billingAlerts" class="mb-6"></div>

        <!-- Current Plan & Usage Overview -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Current Plan -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Current Plan</h3>
                <div id="currentPlan">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-blue-600" id="planName">-</div>
                        <div class="text-xl text-gray-600 mt-2">
                            $<span id="planPrice">-</span>/month
                        </div>
                        <div class="mt-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800" id="subscriptionStatus">
                                Active
                            </span>
                        </div>
                        <div class="mt-4 text-sm text-gray-500">
                            Next billing: <span id="nextBillingDate">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Usage Summary -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">This Month</h3>
                <div class="space-y-4">
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Total Spent</span>
                        <span class="text-sm font-medium text-gray-900">$<span id="totalSpent">-</span></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">Projected Cost</span>
                        <span class="text-sm font-medium text-gray-900">$<span id="projectedCost">-</span></span>
                    </div>
                    <div class="pt-2 border-t">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Auto-renewal</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="autoRenewalToggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="bg-white rounded-lg shadow p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Payment Method</h3>
                <div id="paymentMethod">
                    <div class="flex items-center">
                        <i class="fab fa-cc-visa text-2xl text-blue-600 mr-3"></i>
                        <div>
                            <div class="text-sm font-medium text-gray-900">•••• •••• •••• <span id="cardLast4">-</span></div>
                            <div class="text-sm text-gray-500">Expires <span id="cardExpiry">-</span></div>
                        </div>
                    </div>
                    <button id="updatePaymentBtn" class="mt-4 text-sm text-blue-600 hover:text-blue-800">
                        Update payment method
                    </button>
                </div>
            </div>
        </div>

        <!-- Usage Meters -->
        <div class="bg-white rounded-lg shadow mb-8">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Usage Meters</h3>
            </div>
            <div class="p-6">
                <div id="usageMeters" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Usage meters will be populated here -->
                </div>
            </div>
        </div>

        <!-- Recent Invoices -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium text-gray-900">Recent Invoices</h3>
                <button id="viewAllInvoicesBtn" class="text-sm text-blue-600 hover:text-blue-800">
                    View all invoices
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTable" class="bg-white divide-y divide-gray-200">
                        <!-- Invoices will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Plan Upgrade Modal -->
    <div id="upgradeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Choose Your Plan</h3>
                </div>
                <div class="p-6">
                    <div id="availablePlans" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Plans will be populated here -->
                    </div>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                    <button id="cancelUpgrade" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Method Modal -->
    <div id="paymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen px-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">Update Payment Method</h3>
                </div>
                <div class="p-6">
                    <p class="text-sm text-gray-600 mb-4">
                        You'll be redirected to Stripe to securely update your payment method.
                    </p>
                    <button id="openStripePortal" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        <i class="fab fa-stripe mr-2"></i>Open Stripe Portal
                    </button>
                </div>
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                    <button id="cancelPaymentUpdate" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentTeamId = 'team-001'; // In production, get from authentication
        let billingData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadBillingDashboard();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Upgrade modal
            document.getElementById('upgradeBtn').addEventListener('click', () => {
                loadAvailablePlans();
                document.getElementById('upgradeModal').classList.remove('hidden');
            });

            document.getElementById('cancelUpgrade').addEventListener('click', () => {
                document.getElementById('upgradeModal').classList.add('hidden');
            });

            // Payment method modal
            document.getElementById('updatePaymentBtn').addEventListener('click', () => {
                document.getElementById('paymentModal').classList.remove('hidden');
            });

            document.getElementById('cancelPaymentUpdate').addEventListener('click', () => {
                document.getElementById('paymentModal').classList.add('hidden');
            });

            document.getElementById('openStripePortal').addEventListener('click', openStripePortal);

            // Auto-renewal toggle
            document.getElementById('autoRenewalToggle').addEventListener('change', toggleAutoRenewal);

            // View all invoices
            document.getElementById('viewAllInvoicesBtn').addEventListener('click', () => {
                window.open(`/teams/${currentTeamId}/invoices`, '_blank');
            });
        }

        async function loadBillingDashboard() {
            try {
                const response = await fetch(`/teams/${currentTeamId}/billing-dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    billingData = await response.json();
                    renderBillingDashboard();
                }
            } catch (error) {
                console.error('Error loading billing dashboard:', error);
            }
        }

        function renderBillingDashboard() {
            // Render alerts
            renderBillingAlerts();

            // Render current plan
            document.getElementById('planName').textContent = billingData.current_plan.name;
            document.getElementById('planPrice').textContent = billingData.current_plan.price;
            document.getElementById('subscriptionStatus').textContent = billingData.subscription_status;
            document.getElementById('nextBillingDate').textContent = billingData.next_billing_date ? 
                new Date(billingData.next_billing_date).toLocaleDateString() : 'N/A';

            // Render usage summary
            document.getElementById('totalSpent').textContent = billingData.total_spent_this_month.toFixed(2);
            document.getElementById('projectedCost').textContent = billingData.projected_monthly_cost.toFixed(2);
            document.getElementById('autoRenewalToggle').checked = billingData.auto_renewal_enabled;

            // Render payment method
            if (billingData.payment_methods.length > 0) {
                const pm = billingData.payment_methods.find(p => p.is_default) || billingData.payment_methods[0];
                document.getElementById('cardLast4').textContent = pm.last4;
                document.getElementById('cardExpiry').textContent = `${pm.exp_month}/${pm.exp_year}`;
            }

            // Render usage meters
            renderUsageMeters();

            // Render recent invoices
            renderRecentInvoices();
        }

        function renderBillingAlerts() {
            const alertsContainer = document.getElementById('billingAlerts');
            alertsContainer.innerHTML = '';

            billingData.billing_alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                const severityClasses = {
                    'critical': 'bg-red-50 border-red-200 text-red-800',
                    'high': 'bg-orange-50 border-orange-200 text-orange-800',
                    'medium': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                    'low': 'bg-blue-50 border-blue-200 text-blue-800'
                };

                alertDiv.className = `border-l-4 p-4 mb-4 ${severityClasses[alert.severity] || severityClasses.medium}`;
                alertDiv.innerHTML = `
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas ${alert.type === 'payment_overdue' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium">${alert.title}</h3>
                            <div class="mt-2 text-sm">
                                <p>${alert.message}</p>
                            </div>
                        </div>
                    </div>
                `;
                alertsContainer.appendChild(alertDiv);
            });
        }

        function renderUsageMeters() {
            const container = document.getElementById('usageMeters');
            container.innerHTML = '';

            billingData.usage_meters.forEach(meter => {
                const meterDiv = document.createElement('div');
                meterDiv.className = 'bg-gray-50 rounded-lg p-4';
                
                const progressColor = meter.percentage_used >= 90 ? 'bg-red-500' : 
                                    meter.percentage_used >= 75 ? 'bg-yellow-500' : 'bg-green-500';

                meterDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-sm font-medium text-gray-900">${meter.metric_name}</h4>
                        <span class="text-sm text-gray-500">${meter.percentage_used}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                        <div class="${progressColor} h-2 rounded-full" style="width: ${meter.percentage_used}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>${meter.current_usage.toLocaleString()} ${meter.unit}</span>
                        <span>${meter.limit === -1 ? 'Unlimited' : meter.limit.toLocaleString()} ${meter.unit}</span>
                    </div>
                    ${meter.overage_cost_per_unit ? `
                        <div class="mt-2 text-xs text-gray-500">
                            Overage: $${meter.overage_cost_per_unit} per ${meter.unit}
                        </div>
                    ` : ''}
                `;
                container.appendChild(meterDiv);
            });
        }

        function renderRecentInvoices() {
            const tbody = document.getElementById('invoicesTable');
            tbody.innerHTML = '';

            billingData.recent_invoices.forEach(invoice => {
                const row = document.createElement('tr');
                const statusClasses = {
                    'paid': 'bg-green-100 text-green-800',
                    'open': 'bg-yellow-100 text-yellow-800',
                    'draft': 'bg-gray-100 text-gray-800',
                    'void': 'bg-red-100 text-red-800'
                };

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${invoice.invoice_number}</div>
                        <div class="text-sm text-gray-500">${invoice.description}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${new Date(invoice.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        $${invoice.amount_due.toFixed(2)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClasses[invoice.status]}">
                            ${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        ${invoice.pdf_url ? `<button onclick="downloadInvoice('${invoice.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Download</button>` : ''}
                        ${invoice.status === 'open' ? `<button onclick="payInvoice('${invoice.id}')" class="text-green-600 hover:text-green-900">Pay Now</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function loadAvailablePlans() {
            try {
                const response = await fetch(`/teams/${currentTeamId}/billing-plans`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const plans = await response.json();
                    renderAvailablePlans(plans);
                }
            } catch (error) {
                console.error('Error loading plans:', error);
            }
        }

        function renderAvailablePlans(plans) {
            const container = document.getElementById('availablePlans');
            container.innerHTML = '';

            plans.forEach(plan => {
                const planDiv = document.createElement('div');
                planDiv.className = `border rounded-lg p-6 ${plan.is_current ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`;
                
                planDiv.innerHTML = `
                    <div class="text-center">
                        <h3 class="text-lg font-medium text-gray-900">${plan.name}</h3>
                        <div class="mt-4">
                            <span class="text-4xl font-bold text-gray-900">$${plan.price}</span>
                            <span class="text-base font-medium text-gray-500">/${plan.interval}</span>
                        </div>
                        <ul class="mt-6 space-y-4">
                            ${plan.features.map(feature => `
                                <li class="flex items-center">
                                    <i class="fas fa-check text-green-500 mr-2"></i>
                                    <span class="text-sm text-gray-600">${feature}</span>
                                </li>
                            `).join('')}
                        </ul>
                        <div class="mt-8">
                            ${plan.is_current ? 
                                '<span class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-blue-700 bg-blue-100">Current Plan</span>' :
                                `<button onclick="upgradeToPlan('${plan.id}')" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                    ${plan.price > billingData.current_plan.price ? 'Upgrade' : 'Downgrade'} to ${plan.name}
                                </button>`
                            }
                        </div>
                    </div>
                `;
                container.appendChild(planDiv);
            });
        }

        async function upgradeToPlan(planId) {
            if (!confirm(`Are you sure you want to change to this plan?`)) {
                return;
            }

            try {
                const response = await fetch(`/teams/${currentTeamId}/billing-plans/upgrade`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        new_plan_id: planId,
                        prorate: true
                    })
                });

                if (response.ok) {
                    document.getElementById('upgradeModal').classList.add('hidden');
                    loadBillingDashboard(); // Refresh the dashboard
                    alert('Plan updated successfully!');
                } else {
                    const error = await response.json();
                    alert(`Error updating plan: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error updating plan:', error);
                alert('Error updating plan');
            }
        }

        async function toggleAutoRenewal() {
            const enabled = document.getElementById('autoRenewalToggle').checked;
            
            try {
                const response = await fetch(`/teams/${currentTeamId}/auto-renewal/toggle`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ enabled })
                });

                if (!response.ok) {
                    // Revert toggle if request failed
                    document.getElementById('autoRenewalToggle').checked = !enabled;
                    alert('Error updating auto-renewal setting');
                }
            } catch (error) {
                console.error('Error toggling auto-renewal:', error);
                document.getElementById('autoRenewalToggle').checked = !enabled;
                alert('Error updating auto-renewal setting');
            }
        }

        function openStripePortal() {
            // In production, this would redirect to actual Stripe portal
            alert('Redirecting to Stripe portal...');
            document.getElementById('paymentModal').classList.add('hidden');
        }

        async function downloadInvoice(invoiceId) {
            try {
                const response = await fetch(`/teams/${currentTeamId}/invoices/${invoiceId}/download`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    window.open(result.download_url, '_blank');
                } else {
                    alert('Error downloading invoice');
                }
            } catch (error) {
                console.error('Error downloading invoice:', error);
                alert('Error downloading invoice');
            }
        }

        function payInvoice(invoiceId) {
            // In production, integrate with payment processor
            alert(`Redirecting to payment for invoice ${invoiceId}...`);
        }
    </script>
</body>
</html>
